<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.2.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="5AUIVYTbHIAuz-eQtxSfZbWW5eg9_EVZMSQycIuXrG0">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"cishoon.top","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.20.0","exturl":true,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"default"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":true,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":true,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.json","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/config.min.js"></script>

    <meta name="description" content="《手机安全和可信应用开发指南：TrustZone与OP-TEE技术详解 (网络空间安全技术丛书)》阅读笔记。">
<meta property="og:type" content="article">
<meta property="og:title" content="TrustZone 与 OP-TEE 技术详解">
<meta property="og:url" content="http://cishoon.top/blockchain/OP-TEE/index.html">
<meta property="og:site_name" content="Cishoon&#39;s Blog">
<meta property="og:description" content="《手机安全和可信应用开发指南：TrustZone与OP-TEE技术详解 (网络空间安全技术丛书)》阅读笔记。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://cishoon.top/blockchain/OP-TEE/image-20241008144836831.png">
<meta property="og:image" content="http://cishoon.top/blockchain/OP-TEE/image-20241008145013315.png">
<meta property="og:image" content="http://cishoon.top/blockchain/OP-TEE/image-20241015195330454.png">
<meta property="og:image" content="http://cishoon.top/blockchain/OP-TEE/image-20241015211908095.png">
<meta property="og:image" content="http://cishoon.top/blockchain/OP-TEE/image-20241015212813158.png">
<meta property="article:published_time" content="2024-10-07T16:00:00.000Z">
<meta property="article:modified_time" content="2024-10-25T04:29:25.405Z">
<meta property="article:author" content="Cishoon">
<meta property="article:tag" content="TrustZone">
<meta property="article:tag" content="OP-TEE">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://cishoon.top/blockchain/OP-TEE/image-20241008144836831.png">


<link rel="canonical" href="http://cishoon.top/blockchain/OP-TEE/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"http://cishoon.top/blockchain/OP-TEE/","path":"blockchain/OP-TEE/","title":"TrustZone 与 OP-TEE 技术详解"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>TrustZone 与 OP-TEE 技术详解 | Cishoon's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-43861RVV8R"></script>
  <script class="next-config" data-name="google_analytics" type="application/json">{"tracking_id":"G-43861RVV8R","only_pageview":false,"measure_protocol_api_secret":null}</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/third-party/analytics/google-analytics.min.js"></script>








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
<style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style><link rel="alternate" href="/atom.xml" title="Cishoon's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Cishoon's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">82</span></a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">51</span></a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          目 录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%AF%E4%BF%A1%E6%89%A7%E8%A1%8C%E7%8E%AF%E5%A2%83"><span class="nav-text">1 可信执行环境</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#arm-%E7%9A%84-trustzone-%E6%8A%80%E6%9C%AF"><span class="nav-text">2 Arm 的 TrustZone 技术</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#arm-%E5%8F%AF%E4%BF%A1%E5%9B%BA%E4%BB%B6"><span class="nav-text">3 ARM 可信固件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#op-tee-%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-text">4 OP-TEE 运行环境搭建</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#qemu%E8%BF%90%E8%A1%8Cop-tee%E7%9A%84%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B"><span class="nav-text">5 QEMU运行OP-TEE的启动过程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%89%E5%85%A8%E5%BC%95%E5%AF%BC%E5%8A%9F%E8%83%BD%E5%8F%8Aatf%E7%9A%84%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B"><span class="nav-text">6 安全引导功能及ATF的启动过程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ree-%E4%BE%A7%E7%9A%84%E4%B8%8A%E5%B1%82%E8%BD%AF%E4%BB%B6"><span class="nav-text">7 REE 侧的上层软件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#libteec"><span class="nav-text">7.1 libteec</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E7%BD%AE%E6%8E%A5%E5%8F%A3"><span class="nav-text">7.1.1 内置接口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#teec_initializecontext"><span class="nav-text">TEEC_InitializeContext</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#teec_finalizecontext"><span class="nav-text">TEEC_FinalizeContext</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#teec_opensession"><span class="nav-text">TEEC_OpenSession</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#teec_closesession"><span class="nav-text">TEEC_CloseSession</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#teec_invokecommand"><span class="nav-text">TEEC_InvokeCommand</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A6%82%E6%9E%9C%E5%8F%82%E6%95%B0%E5%A4%A7%E4%BA%8E4%E4%B8%AA"><span class="nav-text">如果参数大于4个？</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#teec_requestcancellation"><span class="nav-text">TEEC_RequestCancellation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#teec_registersharememory"><span class="nav-text">TEEC_RegisterShareMemory</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#teec_registersharememoryfiledescriptor"><span class="nav-text">TEEC_RegisterShareMemoryFileDescriptor</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#teec_allocatesharedmemory"><span class="nav-text">TEEC_AllocateSharedMemory</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AF%B9%E6%AF%94-register-%E5%92%8C-allocate"><span class="nav-text">对比 Register 和 Allocate</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#teec_releasesharedmemory"><span class="nav-text">TEEC_ReleaseSharedMemory</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E7%94%A8-libteec-%E7%9A%84%E6%B5%81%E7%A8%8B"><span class="nav-text">7.1.2 调用 libteec 的流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#tee_supplicant"><span class="nav-text">7.2 tee_supplicant</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD%E5%92%8C%E4%BD%9C%E7%94%A8"><span class="nav-text">主要功能和作用：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tee_supplicant-%E7%9A%84%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="nav-text">tee_supplicant 的架构图：</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#ree-%E4%BE%A7%E7%9A%84-op-tee-%E9%A9%B1%E5%8A%A8"><span class="nav-text">8 REE 侧的 OP-TEE 驱动</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Cishoon"
      src="/images/cishoon.jpg">
  <p class="site-author-name" itemprop="name">Cishoon</p>
  <div class="site-description" itemprop="description">一条数学公式 + 一个简单的故事</div>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Npc2hvb24=" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;cishoon"><i class="fab fa-github fa-fw"></i></span>
      </span>
      <span class="links-of-author-item">
        <span class="exturl" data-url="aHR0cHM6Ly9zcGFjZS5iaWxpYmlsaS5jb20vMTA2Njk1NDg4" title="哔哩哔哩 → https:&#x2F;&#x2F;space.bilibili.com&#x2F;106695488"><i class="fa-brands fa-bilibili fa-fw"></i></span>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cishoon.top/blockchain/OP-TEE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/cishoon.jpg">
      <meta itemprop="name" content="Cishoon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cishoon's Blog">
      <meta itemprop="description" content="一条数学公式 + 一个简单的故事">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="TrustZone 与 OP-TEE 技术详解 | Cishoon's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          TrustZone 与 OP-TEE 技术详解<span class="exturl post-edit-link" data-url="aHR0cHM6Ly9naXRodWIuY29tL0Npc2hvb24vYmxvZy90cmVlL21haW4vc291cmNlL19wb3N0cy9ibG9ja2NoYWluL09QLVRFRS5tZA==" title="编辑"><i class="fa fa-pen-nib"></i></span>
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2024-10-08 00:00:00" itemprop="dateCreated datePublished" datetime="2024-10-08T00:00:00+08:00">2024-10-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>9.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>9 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><p>《手机安全和可信应用开发指南：TrustZone与OP-TEE技术详解
(网络空间安全技术丛书)》阅读笔记。</p>
<span id="more"></span>
<h1 id="可信执行环境">1 可信执行环境</h1>
<p>TrustZone
实现了一个<strong>芯片级</strong>的安全扩展组件，去验证CPU发送的数据访问请求的<strong>非安全状态读写信号位
（Non-secure bit，NS
bit）</strong>，0表示该请求是安全的，1表示该请求是非安全的。</p>
<p>当非安全请求试图访问安全数据时，该请求会被认为是非法的。</p>
<p>TEE 是一套完整的解决方案，包括：</p>
<ul>
<li><p><strong>正常世界状态的客户端应用</strong></p>
<p>OP-TEE 中的 host 部分；Client Application（CA）</p></li>
<li><p><strong>安全世界状态的可信应用</strong></p>
<p>OP-TEE 中的 ta 部分；Trusted Application（TA）</p></li>
<li><p><strong>可信硬件驱动</strong>（Secure Driver）</p></li>
<li><p><strong>可信内核系统</strong>（TEE OS）</p></li>
</ul>
<h1 id="arm-的-trustzone-技术">2 Arm 的 TrustZone 技术</h1>
<p>在缓存、内存管理单元、总线等资源上增加了安全位。实现了外部资源和内存资源的硬件隔离。这些硬件隔离包括中断隔离、片上RAM和ROM的隔离、片外RAM和ROM的隔离、外围设备的硬件隔离、外部RAM和ROM的隔离等。</p>
<p>这部分内容过于硬件，看不懂，暂时跳过。</p>
<h1 id="arm-可信固件">3 ARM 可信固件</h1>
<p>ARM 可信任固件（ARM Trusted
Firmware，ATF）是由ARM官方提供的底层固件，该固件统一了ARM底层接口标准，如电源状态控制接口
（Power Status Control Interface，PSCI）、安全启动需求（Trusted Board
Boot
Requirements，TBBR）、安全世界状态（SWS）与正常世界状态（NWS）切换的安全监控模式调用（secure
monitor
call，smc）操作等。ATF旨在将ARM底层的操作统一使代码能够重用和便于移植。</p>
<p>ATF的源代码共分为bl1、bl2、bl31、bl32、bl33部分。</p>
<p>其中bl1、bl2、bl31部分属于固定的固件。</p>
<p>bl32和bl33分别用于加载TEE OS和REE侧的镜像。</p>
<p>第六章将有详细讲解。</p>
<h1 id="op-tee-运行环境搭建">4 OP-TEE 运行环境搭建</h1>
<p>略。见我的 <span class="exturl" data-url="aHR0cHM6Ly9jaXNob29uLmdpdGh1Yi5pby9ncmFkdWF0aW9uLXByb2plY3QvMDEv">毕设01<i class="fa fa-external-link-alt"></i></span> 和 <span class="exturl" data-url="aHR0cHM6Ly9jaXNob29uLmdpdGh1Yi5pby9ncmFkdWF0aW9uLXByb2plY3QvMDIv">毕设02<i class="fa fa-external-link-alt"></i></span>。</p>
<h1 id="qemu运行op-tee的启动过程">5 QEMU运行OP-TEE的启动过程</h1>
<p>由第四章得知，在 <code>build</code> 目录执行
<code>make run-only</code> 即可在 QEMU 中启动 OP-TEE。</p>
<p>这个过程主要加载 <code>bios.bin</code> 文件，并从该镜像中分离Linux
内核镜像和 OP-TEE 镜像以及 rootfs 镜像。并将rootfs作为根文件系统挂载到
Linux 系统中。</p>
<h1 id="安全引导功能及atf的启动过程">6 安全引导功能及ATF的启动过程</h1>
<p>安全引导通过电子签名保证系统中重要镜像文件的完整性。OP-TEE 的
BootLoader 镜像文件、TEE 镜像文件、Linux
内核镜像文件等等都使用了安全引导功能。</p>
<p>一个直观的感受是，当前大多数 ARM
芯片的系统，如果用户非法刷入其他厂商的 ROM 后手机无法正常启动。</p>
<p>实现方法是在芯片出厂时，就在 ChipRom
固化了一部分代码。RSA公钥或哈希值会在出厂之前写入到
<code>OTP/efuse</code> 中，只有 ChipRom 和 TEE
可以读取其中的内容且无法修改。</p>
<p>ARMv7的安全引导过程：</p>
<figure>
<img src="/blockchain/OP-TEE/image-20241008144836831.png" alt="image-20241008144836831">
<figcaption aria-hidden="true">image-20241008144836831</figcaption>
</figure>
<p>ARMv8的安全引导过程：</p>
<figure>
<img src="/blockchain/OP-TEE/image-20241008145013315.png" alt="image-20241008145013315">
<figcaption aria-hidden="true">image-20241008145013315</figcaption>
</figure>
<p>完全没看懂……</p>
<h1 id="ree-侧的上层软件">7 REE 侧的上层软件</h1>
<p>文中说：“REE 侧的上层软件包括 <code>libteec</code> 库和
<code>tee_supplicant</code> 。”</p>
<p>这里的上层软件，指的不是用户编写的程序或操作系统的软件，<strong>上层</strong>指的是提供的库。</p>
<p><code>libteec</code> 库提供 CA 程序运行时的基本接口。</p>
<p><code>tee_supplicant</code> 处理来自 TEE 侧的 RPC 请求。</p>
<figure>
<img src="/blockchain/OP-TEE/image-20241015195330454.png" alt="image-20241015195330454">
<figcaption aria-hidden="true">image-20241015195330454</figcaption>
</figure>
<h2 id="libteec">7.1 libteec</h2>
<h3 id="内置接口">7.1.1 内置接口</h3>
<p>提供了总共 10 个 API 接口。</p>
<h4 id="teec_initializecontext">TEEC_InitializeContext</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">TEEC_Result <span class="title function_">TEEC_InitializeContext</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *name, TEEC_Context *ctx)</span></span><br></pre></td></tr></table></figure>
<p><code>TEEC_InitializeContext</code> 是 OP-TEE
中的一个函数，用于初始化与 TEE (Trusted Execution Environment)
通信的上下文 (Context)。这是 TEE 客户端与 TEE
系统之间建立通信的第一步。它为后续的安全操作（如打开会话、调用信任应用程序等）创建一个上下文环境。</p>
<p><code>name</code>（<code>const char \*name</code>）：</p>
<ul>
<li>这是一个指向字符串的指针，通常表示 TEE
的名称。在大多数情况下，该参数可以传入 <code>NULL</code>，表示使用默认的
TEE 实现（通常是 OP-TEE）。</li>
<li>如果你有多个 TEE 实现，或者特定的 TEE
配置，你可以传递一个特定的名称来标识你想使用的 TEE。</li>
</ul>
<p><code>ctx</code>（<code>TEEC_Context \*ctx</code>）：</p>
<ul>
<li>这是一个指向 <code>TEEC_Context</code>
结构体的指针，函数通过这个指针返回一个已初始化的上下文对象。这个上下文对象将用于后续的
TEE 操作，如打开会话 (<code>TEEC_OpenSession</code>) 和执行命令
(<code>TEEC_InvokeCommand</code>)。</li>
<li>调用这个函数时，必须为 <code>ctx</code>
提供一个有效的指针，函数会将上下文的初始化结果存储在这个结构体中。</li>
</ul>
<p>返回值：</p>
<ul>
<li>函数返回类型是 <code>TEEC_Result</code>，它表示操作的结果。如果返回
<code>TEEC_SUCCESS</code>，说明上下文初始化成功；否则返回一个错误代码，表示初始化失败。</li>
</ul>
<h4 id="teec_finalizecontext">TEEC_FinalizeContext</h4>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">TEEC_FinalizeContext</span><span class="params">(TEEC_Context *ctx)</span></span><br></pre></td></tr></table></figure>
<p>释放一个已经被初始化的类型为TEEC_Context的变量，关闭CA与TEE之间的连接。</p>
<h4 id="teec_opensession">TEEC_OpenSession</h4>
<p><code>TEEC_OpenSession</code> 函数用于在客户端应用程序（位于 Normal
World）和 TEE 中的信任应用程序（位于 Secure
World）之间建立会话。会话建立后，客户端可以通过会话与 TA
进行命令传递和数据交换。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">TEEC_Result <span class="title function_">TEEC_OpenSession</span><span class="params">(TEEC_Context *ctx,</span></span><br><span class="line"><span class="params">                             TEEC_Session *session,</span></span><br><span class="line"><span class="params">                             <span class="type">const</span> TEEC_UUID *destination,</span></span><br><span class="line"><span class="params">                             <span class="type">uint32_t</span> connectionMethod,</span></span><br><span class="line"><span class="params">                             <span class="type">const</span> <span class="type">void</span> *connectionData,</span></span><br><span class="line"><span class="params">                             TEEC_Operation *operation,</span></span><br><span class="line"><span class="params">                             <span class="type">uint32_t</span> *returnOrigin)</span>;</span><br></pre></td></tr></table></figure>
<p><strong>参数解释</strong>：</p>
<ol type="1">
<li><p><strong><code>ctx</code>（<code>TEEC_Context \*ctx</code>）：</strong></p>
<ul>
<li>这是一个指向已初始化的 <code>TEEC_Context</code>
结构体的指针，它用于指定会话的上下文环境。这个上下文必须通过之前调用的
<code>TEEC_InitializeContext</code> 函数初始化。</li>
<li>它代表了客户端与 TEE
的通信通道，所有后续的操作都是基于这个上下文进行的。</li>
</ul></li>
<li><p><strong><code>session</code>（<code>TEEC_Session \*session</code>）：</strong></p>
<ul>
<li>这是一个指向 <code>TEEC_Session</code>
结构体的指针，函数通过这个指针返回一个已打开的会话对象。后续客户端与 TA
的通信将基于这个会话进行。</li>
<li>调用 <code>TEEC_OpenSession</code>
后，成功建立的会话会被存储在这个结构体中，后续的命令调用等操作将依赖这个会话对象。</li>
</ul></li>
<li><p><strong><code>destination</code>（<code>const TEEC_UUID \*destination</code>）：</strong></p>
<ul>
<li>这是一个指向 <code>TEEC_UUID</code>
结构体的指针，表示目标信任应用程序（TA）的唯一标识符。每个 TA
都有一个唯一的 UUID，用于标识它。</li>
<li>客户端通过 UUID 告诉 TEE 需要连接的具体 TA。</li>
</ul></li>
<li><p><strong><code>connectionMethod</code>（<code>uint32_t connectionMethod</code>）：</strong></p>
<ul>
<li>该参数用于指定会话的连接方法。在 OP-TEE 中，通常使用的连接方法是
<code>TEEC_LOGIN_PUBLIC</code>，表示不需要额外的身份验证信息即可连接到
TA。</li>
<li>其他可能的连接方法包括基于用户身份或组身份的验证方法，如
<code>TEEC_LOGIN_USER</code> 和 <code>TEEC_LOGIN_GROUP</code>。</li>
</ul></li>
<li><p><strong><code>connectionData</code>（<code>const void \*connectionData</code>）：</strong></p>
<ul>
<li>这是与 <code>connectionMethod</code>
相关的数据指针。在大多数情况下，当使用 <code>TEEC_LOGIN_PUBLIC</code>
时，这个参数可以设置为 <code>NULL</code>，因为不需要额外的数据。</li>
<li>如果使用特定的连接方法，这里可能需要传递额外的身份验证数据。</li>
</ul></li>
<li><p><strong><code>operation</code>（<code>TEEC_Operation \*operation</code>）：</strong></p>
<ul>
<li>这是一个指向 <code>TEEC_Operation</code>
结构体的指针，表示需要在打开会话时传递的操作数据。如果不需要传递任何操作，可以将其设置为
<code>NULL</code>。</li>
<li>这个结构体包含客户端与 TA
之间的参数和共享内存，用于传递数据或命令。</li>
</ul></li>
<li><p><strong><code>returnOrigin</code>（<code>uint32_t \*returnOrigin</code>）：</strong></p>
<ul>
<li><p>这是一个用于返回错误来源的指针。当会话建立失败时，</p>
<p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">returnOrigin</span><br></pre></td></tr></table></figure></p>
<p>会指示错误是发生在客户端、TEE 系统还是 TA 内部。常见的返回值有：</p>
<ul>
<li><code>TEEC_ORIGIN_API</code>：表示错误来自 API 调用本身。</li>
<li><code>TEEC_ORIGIN_COMMS</code>：表示错误发生在与 TEE 的通信层。</li>
<li><code>TEEC_ORIGIN_TEE</code>：表示错误来自 TEE 系统。</li>
<li><code>TEEC_ORIGIN_TRUSTED_APP</code>：表示错误来自 TA。</li>
</ul></li>
</ul></li>
</ol>
<p><strong>返回值</strong>：</p>
<ul>
<li><p>函数返回类型为</p>
<p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">TEEC_Result</span><br></pre></td></tr></table></figure></p>
<p>它表示操作的结果。</p>
<ul>
<li>如果返回 <code>TEEC_SUCCESS</code>，表示会话成功打开。</li>
<li>否则返回错误代码，表示会话建立失败。</li>
</ul></li>
</ul>
<h4 id="teec_closesession">TEEC_CloseSession</h4>
<p>关闭一个 session</p>
<h4 id="teec_invokecommand">TEEC_InvokeCommand</h4>
<p>用于在客户端与信任应用程序 (Trusted Application, TA)
之间执行命令的函数。通过这个函数，客户端可以请求 TA
执行特定的安全操作或服务，并交换数据。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">TEEC_Result <span class="title function_">TEEC_InvokeCommand</span><span class="params">(TEEC_Session *session,</span></span><br><span class="line"><span class="params">                               <span class="type">uint32_t</span> commandID,</span></span><br><span class="line"><span class="params">                               TEEC_Operation *operation,</span></span><br><span class="line"><span class="params">                               <span class="type">uint32_t</span> *returnOrigin)</span>;</span><br></pre></td></tr></table></figure>
<p>参数解释：</p>
<p><code>commandID</code>（<code>uint32_t commandID</code>）：</p>
<ul>
<li>表示客户端请求 TA 执行的具体命令的标识符。每个 TA
都可以定义一组命令，每个命令有一个唯一的
<code>commandID</code>，用于区分不同的操作。</li>
</ul>
<p><code>operation</code>（<code>TEEC_Operation \*operation</code>）：</p>
<ul>
<li>这是一个指向 <code>TEEC_Operation</code>
结构体的指针，表示本次命令执行时传递的参数或数据。如果没有参数要传递，可以将其设置为
<code>NULL</code>。</li>
<li><code>TEEC_Operation</code> 是客户端与 TA
之间传递数据、参数和共享内存的机制。这个结构体包含四个参数槽（<code>paramTypes</code>
和
<code>params[]</code>），每个槽都可以存储不同类型的数据（如值、内存引用等）。</li>
</ul>
<p>结构体中包含的四个参数槽类型可以是以下几种类型：</p>
<ul>
<li><code>TEEC_NONE</code>：表示没有参数。</li>
<li><code>TEEC_VALUE_INPUT</code>：表示输入类型的简单值参数。</li>
<li><code>TEEC_VALUE_OUTPUT</code>：表示输出类型的简单值参数。</li>
<li><code>TEEC_VALUE_INOUT</code>：表示输入和输出类型的简单值参数。</li>
<li><code>TEEC_MEMREF_TEMP_INPUT</code>：表示传递临时输入的内存引用。</li>
<li><code>TEEC_MEMREF_TEMP_OUTPUT</code>：表示接收临时输出的内存引用。</li>
<li><code>TEEC_MEMREF_WHOLE</code>：表示整个共享内存块。</li>
<li><code>TEEC_MEMREF_PARTIAL_INPUT/OUTPUT</code>：表示部分输入或输出的共享内存。</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> {</span></span><br><span class="line">    TEEC_Session *session,  <span class="comment">// 启用该操作的会话</span></span><br><span class="line">    <span class="type">uint32_t</span> started;       <span class="comment">// 指示操作是否已启动（通常由内部使用）</span></span><br><span class="line">    <span class="type">uint32_t</span> paramTypes;    <span class="comment">// 参数类型，用来定义 params 中的每个参数的类型</span></span><br><span class="line">    TEEC_Parameter params[<span class="number">4</span>]; <span class="comment">// 参数数组，最多可以传递4个参数</span></span><br><span class="line">    TEEC_SharedMemory *memRefs; <span class="comment">// 可选，用于传递共享内存（如果有）</span></span><br><span class="line">} TEEC_Operation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> {</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> {</span></span><br><span class="line">        <span class="type">uint32_t</span> a;</span><br><span class="line">        <span class="type">uint32_t</span> b;</span><br><span class="line">    } value;  <span class="comment">// 简单值，a 和 b 分别表示两个 32 位的整数</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> {</span></span><br><span class="line">        <span class="type">void</span> *buffer;</span><br><span class="line">        <span class="type">size_t</span> size;</span><br><span class="line">    } tmpref;  <span class="comment">// 临时内存引用</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> {</span></span><br><span class="line">        TEEC_SharedMemory *parent;</span><br><span class="line">        <span class="type">size_t</span> size;</span><br><span class="line">        <span class="type">size_t</span> offset;</span><br><span class="line">    } memref;  <span class="comment">// 共享内存引用</span></span><br><span class="line">} TEEC_Parameter;</span><br></pre></td></tr></table></figure>
<p>使用示例：</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">TEEC_Result res;</span><br><span class="line">TEEC_Session session;</span><br><span class="line">TEEC_Operation op;</span><br><span class="line"><span class="type">uint32_t</span> returnOrigin;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 假设已经通过 TEEC_OpenSession 成功打开了 session</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置需要传递的参数</span></span><br><span class="line"><span class="built_in">memset</span>(&amp;op, <span class="number">0</span>, <span class="keyword">sizeof</span>(op));</span><br><span class="line">op.paramTypes = TEEC_PARAM_TYPES(TEEC_VALUE_INPUT, TEEC_NONE, TEEC_NONE, TEEC_NONE);</span><br><span class="line">op.params[<span class="number">0</span>].value.a = <span class="number">42</span>;  <span class="comment">// 传递参数值</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用命令，commandID 为 0x1234</span></span><br><span class="line">res = TEEC_InvokeCommand(&amp;session, <span class="number">0x1234</span>, &amp;op, &amp;returnOrigin);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (res != TEEC_SUCCESS) {</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Command failed, error: 0x%x, origin: 0x%x\n"</span>, res, returnOrigin);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h5 id="如果参数大于4个">如果参数大于4个？</h5>
<p>可以使用共享内存，传递一整块内存区域；或将参数打包成结构体。</p>
<h4 id="teec_requestcancellation">TEEC_RequestCancellation</h4>
<p><code>TEEC_RequestCancellation</code>
函数用于请求取消客户端已发起的某个异步操作。并不是所有操作都支持取消，这取决于具体的信任应用程序
(Trusted Application, TA)
以及操作是否支持中途取消。调用这个函数不会立即终止操作，而是请求 TEE
停止当前命令的执行。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">TEEC_RequestCancellation</span><span class="params">(TEEC_Operation *operation)</span>;</span><br></pre></td></tr></table></figure>
<h4 id="teec_registersharememory">TEEC_RegisterShareMemory</h4>
<p>用于在客户端和 TEE（Trusted Execution
Environment）之间注册一块共享内存。共享内存区域用于在客户端和信任应用程序（Trusted
Application,
TA）之间传递数据。通过这个函数，客户端可以将其自身的内存区域注册为共享内存，以便在安全世界和普通世界之间进行数据交换。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">TEEC_Result <span class="title function_">TEEC_RegisterSharedMemory</span><span class="params">(TEEC_Context *ctx,</span></span><br><span class="line"><span class="params">                                      TEEC_SharedMemory *sharedMem)</span>;</span><br></pre></td></tr></table></figure>
<p><code>TEEC_SharedMemory</code> 结构体的主要字段：</p>
<ul>
<li><code>void \*buffer</code>：指向客户端内存区域的指针，表示需要注册为共享内存的内存块。</li>
<li><code>size_t size</code>：表示内存块的大小（字节数）。</li>
<li><code>uint32_t flags</code>：用于标识共享内存的使用方式，常见的值有：
<ul>
<li><code>TEEC_MEM_INPUT</code>：表示共享内存是输入内存，客户端将数据传递给
TEE。</li>
<li><code>TEEC_MEM_OUTPUT</code>：表示共享内存是输出内存，TEE
将数据传递给客户端。</li>
<li><code>TEEC_MEM_INPUT | TEEC_MEM_OUTPUT</code>：表示共享内存既可以作为输入，也可以作为输出。</li>
</ul></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">TEEC_SharedMemory sharedMem;</span><br><span class="line">TEEC_Context ctx;</span><br><span class="line">TEEC_Result res;</span><br><span class="line"><span class="type">void</span> *buffer;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化 TEE 上下文</span></span><br><span class="line">res = TEEC_InitializeContext(<span class="literal">NULL</span>, &amp;ctx);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 分配客户端的内存区域</span></span><br><span class="line">buffer = <span class="built_in">malloc</span>(<span class="number">1024</span>); <span class="comment">// 分配1KB的内存</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置共享内存参数</span></span><br><span class="line">sharedMem.buffer = buffer;</span><br><span class="line">sharedMem.size = <span class="number">1024</span>;</span><br><span class="line">sharedMem.flags = TEEC_MEM_INPUT; <span class="comment">// 该共享内存用于传递输入数据</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册共享内存</span></span><br><span class="line">res = TEEC_RegisterSharedMemory(&amp;ctx, &amp;sharedMem);</span><br><span class="line"><span class="keyword">if</span> (res != TEEC_SUCCESS) {</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Shared memory registration failed, error code: 0x%x\n"</span>, res);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 执行其他操作，比如使用 TEEC_InvokeCommand 传递该共享内存...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 完成后，释放共享内存</span></span><br><span class="line">TEEC_ReleaseSharedMemory(&amp;sharedMem);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 释放分配的内存</span></span><br><span class="line"><span class="built_in">free</span>(buffer);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 最终关闭 TEE 上下文</span></span><br><span class="line">TEEC_FinalizeContext(&amp;ctx);</span><br></pre></td></tr></table></figure>
<h4 id="teec_registersharememoryfiledescriptor">TEEC_RegisterShareMemoryFileDescriptor</h4>
<p>用于通过文件描述符将内存区域注册为共享内存，从而在客户端和
TEE（Trusted Execution Environment）之间进行数据传递。与
<code>TEEC_RegisterSharedMemory</code>
函数不同的是，<code>TEEC_RegisterSharedMemoryFileDescriptor</code>
允许客户端通过文件描述符直接引用内存，这对于内存映射文件或设备共享内存区域非常有用。</p>
<h4 id="teec_allocatesharedmemory">TEEC_AllocateSharedMemory</h4>
<p>用于在客户端与 TEE（Trusted Execution
Environment）之间分配一块共享内存。与
<code>TEEC_RegisterSharedMemory</code>
不同，<code>TEEC_AllocateSharedMemory</code> 由 TEE
客户端库直接为客户端分配内存区域，而不是由客户端自己预先分配并注册。这在需要动态分配内存时非常有用。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">TEEC_Result res;</span><br><span class="line">TEEC_Context ctx;</span><br><span class="line">TEEC_SharedMemory sharedMem;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初始化 TEE 上下文</span></span><br><span class="line">res = TEEC_InitializeContext(<span class="literal">NULL</span>, &amp;ctx);</span><br><span class="line"><span class="keyword">if</span> (res != TEEC_SUCCESS) {</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Failed to initialize context: 0x%x\n"</span>, res);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置共享内存的大小和标志</span></span><br><span class="line">sharedMem.size = <span class="number">4096</span>;  <span class="comment">// 分配 4KB 内存</span></span><br><span class="line">sharedMem.flags = TEEC_MEM_INPUT | TEEC_MEM_OUTPUT;  <span class="comment">// 该共享内存用于双向传递数据</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 分配共享内存</span></span><br><span class="line">res = TEEC_AllocateSharedMemory(&amp;ctx, &amp;sharedMem);</span><br><span class="line"><span class="keyword">if</span> (res != TEEC_SUCCESS) {</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"Failed to allocate shared memory: 0x%x\n"</span>, res);</span><br><span class="line">    TEEC_FinalizeContext(&amp;ctx);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// 现在可以使用 sharedMem.buffer 指向的内存区域</span></span><br><span class="line"><span class="comment">// 执行其他操作，如通过 TEEC_InvokeCommand 传递数据...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 完成后释放共享内存</span></span><br><span class="line">TEEC_ReleaseSharedMemory(&amp;sharedMem);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 最终关闭 TEE 上下文</span></span><br><span class="line">TEEC_FinalizeContext(&amp;ctx);</span><br></pre></td></tr></table></figure>
<h5 id="对比-register-和-allocate">对比 Register 和 Allocate</h5>
<ul>
<li><p><strong>Register</strong>：将一块已经分配好了的内存空间，<strong>注册</strong>为共享内存。例如在
CA 中有一个动态分配空间（即使用 <code>malloc</code>
）的数组，可以直接将这个数组注册为共享内存，供 TA 使用。</p>
<ul>
<li><p>当有些内存空间已经通过其他方式分配了，（例如与设备共享的内存、通过
DMA 机制获取的内存块等），就可以直接通过注册共享内存让 TA
访问这部分内存空间。</p></li>
<li><p>当执行 Release
时，只会取消内存空间的共享，需要后续进行手动释放。</p></li>
<li><p>总结：将已有的空间共享给 TA，所以叫注册。</p></li>
</ul></li>
<li><p><strong>Allocate</strong>：不需要已分配的内存空间，这个函数里包含了创建空间的过程。</p>
<ul>
<li>一个简化的共享内存管理。我只是想共享一块内存，这个内存并没有其他含义。</li>
<li>当执行 Release 时，会自动释放内存空间。（更简便）</li>
</ul></li>
</ul>
<h4 id="teec_releasesharedmemory">TEEC_ReleaseSharedMemory</h4>
<p>释放共享内存空间。</p>
<h4 id="总结">总结</h4>
<ul>
<li><p>初始化、释放 <em>Context</em></p></li>
<li><p>打开、关闭 <em>Session</em></p></li>
<li><p>执行、终止 <em>Command</em></p></li>
<li><p>注册、分配、释放 <em>共享内存</em></p>
<ul>
<li>注册额外有一个共享文件</li>
</ul></li>
</ul>
<h3 id="调用-libteec-的流程">7.1.2 调用 libteec 的流程</h3>
<figure>
<img src="/blockchain/OP-TEE/image-20241015211908095.png" alt="image-20241015211908095">
<figcaption aria-hidden="true">image-20241015211908095</figcaption>
</figure>
<h2 id="tee_supplicant">7.2 tee_supplicant</h2>
<blockquote>
<p><code>tee_supplicant</code> 是 OP-TEE
中的一个用户态进程，用于在普通世界（Normal World）和安全世界（Secure
World）之间提供辅助功能。它负责处理 TEE
中某些操作中需要普通世界支持的请求。简而言之，<code>tee_supplicant</code>
是普通世界中的辅助守护进程，为 TEE
提供支持，特别是文件系统和共享内存等功能。</p>
<h3 id="主要功能和作用">主要功能和作用：</h3>
<p>在 OP-TEE 体系中，<code>tee_supplicant</code>
的主要任务是处理由安全世界发出的某些特定类型的请求，例如： 1.
<strong>文件系统访问</strong>：TA（Trusted
Application，信任应用程序）可能需要访问文件系统，而安全世界是隔离的，不能直接操作普通世界的文件系统。因此，TA
需要通过 <code>tee_supplicant</code> 来进行文件 I/O 操作。 2.
<strong>共享内存分配</strong>：在某些场景下，安全世界可能需要更多的共享内存区域，而这些内存需要通过普通世界进行分配和管理，<code>tee_supplicant</code>
也负责这类请求。 3.
<strong>加密算法支持</strong>：有些信任应用程序需要依赖普通世界中提供的加密支持，比如
OpenSSL 之类的库，<code>tee_supplicant</code> 充当桥梁来调用这些服务。
4. <strong>启动和管理 TEE 功能</strong>：<code>tee_supplicant</code>
在系统启动时运行，确保 TEE 相关资源和服务准备就绪。</p>
<h3 id="tee_supplicant-的架构图">tee_supplicant 的架构图：</h3>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">+-------------------+      +----------------------+      +---------------------+</span><br><span class="line">|   Secure World    |      |  Normal World        |      |  Linux Filesystem   |</span><br><span class="line">|                   |      |                      |      |                     |</span><br><span class="line">| +--------------+  |      |  +----------------+  |      |  +---------------+  |</span><br><span class="line">| |  Trusted     |  |&lt;----&gt;|  | tee_supplicant |  |&lt;----&gt;|  | Files and Data|  |</span><br><span class="line">| |  Application |  |      |  +----------------+  |      |  +---------------+  |</span><br><span class="line">| +--------------+  |      |                      |      |                     |</span><br><span class="line">|                   |      |                      |      |                     |</span><br><span class="line">+-------------------+      +----------------------+      +---------------------+</span><br></pre></td></tr></table></figure>
</blockquote>
<p>即，当 TA 需要用到普通世界中的数据、接口等功能时，TEE 就向
<code>tee_supplicant</code> 发送请求 (tee 乞求) 。然后由普通世界的
<code>tee_supplicant</code>
处理请求，执行类似获取数据、访问文件、调用函数等操作。</p>
<figure>
<img src="/blockchain/OP-TEE/image-20241015212813158.png" alt="image-20241015212813158">
<figcaption aria-hidden="true">image-20241015212813158</figcaption>
</figure>
<p>TA 能向 <code>tee_supplicant</code> 发送的请求有：</p>
<ul>
<li>从文件系统中读取TA的镜像保存在共享内存中<br>
</li>
<li>对文件系统中的节点进行读/写/打开/关闭/移除等操作<br>
</li>
<li>执行RPMB（EMMC中的RPMB分区）相关操作<br>
</li>
<li>分配共享内存<br>
</li>
<li>释放共享内存<br>
</li>
<li>处理gprof请求<br>
</li>
<li>执行网络socket请求</li>
</ul>
<h1 id="ree-侧的-op-tee-驱动">8 REE 侧的 OP-TEE 驱动</h1>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/TrustZone/" rel="tag"><i class="fa fa-tag"></i> TrustZone</a>
              <a href="/tags/OP-TEE/" rel="tag"><i class="fa fa-tag"></i> OP-TEE</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/graduation-project/05/" rel="prev" title="毕设05 - WATZ 迁移">
                  <i class="fa fa-angle-left"></i> 毕设05 - WATZ 迁移
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/graduation-project/04/" rel="next" title="毕设04 - 阶段性总结，明确题目">
                  毕设04 - 阶段性总结，明确题目 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2024 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Cishoon</span>
  </div><div class="footer-custom">
Website source code <span class="exturl theme-link" data-url="aHR0cHM6Ly9naXRodWIuY29tL0Npc2hvb24vYmxvZw==">here</span>
</div>


    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

  <span class="exturl github-corner" data-url="aHR0cHM6Ly9naXRodWIuY29tL0Npc2hvb24=" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></span>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.1.0/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/comments.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/utils.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/motion.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/sidebar.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/next-boot.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/pjax.min.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/third-party/search/local-search.min.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.0/mermaid.min.js","integrity":"sha256-stuqcu2FrjYCXDOytWFA5SoUE/r3nkp6gTglzNSlavU="}}</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/third-party/tags/mermaid.min.js"></script>

  <script class="next-config" data-name="wavedrom" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/wavedrom.min.js","integrity":"sha256-INLAoJc6quTNfiMWkGZniYO2cxE8mHpddnLow1m6RFs="}}</script>
  <script class="next-config" data-name="wavedrom_skin" type="application/json">{"enable":true,"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/wavedrom/3.5.0/skins/default.js","integrity":"sha256-fduc/Zszk5ezWws2uInY/ALWVmIrmV6VTgXbsYSReFI="}}</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/third-party/tags/wavedrom.min.js"></script>




  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":"true                   ---------------------> 设置为true","tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-theme-next/8.20.0/third-party/math/mathjax.min.js"></script>



</body>
</html>
